# Как работает менеджер корреляции торговых пар

## Обзор

**Цель:** Предотвратить открытие множества позиций по коррелирующим парам, чтобы избежать концентрации риска.

**Пример проблемы без корреляционного менеджера:**
- Открыли Long BTC
- Открыли Long ETH
- Открыли Long SOL
- BTC падает → ETH и SOL тоже падают (высокая корреляция)
- **Результат:** 3 убыточные позиции вместо 1

---

## Как торговые пары попадают в одну группу

### Шаг 1: Загрузка исторических данных

Для каждой торговой пары загружается **30 дней** дневных свечей (configurable):

```python
# Параметры из .env
CORRELATION_LOOKBACK_DAYS=30  # Период расчета корреляции
```

**Что загружается:**
- Дневные свечи (1D interval)
- Close цены для каждого дня
- Пример: [50000, 51000, 49500, 52000, ...] для BTCUSDT

---

### Шаг 2: Расчет Returns (процентных изменений)

Для каждой пары вычисляются **returns** - процентные изменения цены день к дню:

```python
Return[t] = (Price[t] - Price[t-1]) / Price[t-1]
```

**Пример для BTCUSDT:**
```
Day 1: 50000 USD
Day 2: 51000 USD → Return = (51000 - 50000) / 50000 = 0.02 (2%)
Day 3: 49500 USD → Return = (49500 - 51000) / 51000 = -0.0294 (-2.94%)
```

**Зачем returns, а не цены?**
- Returns показывают направление движения (рост/падение)
- Нормализованы (не зависят от абсолютного уровня цен)
- BTC по $50k и ETH по $3k имеют сопоставимые returns

---

### Шаг 3: Расчет корреляции между ВСЕМИ парами

Используется **Pearson correlation coefficient** - мера линейной зависимости:

```
Correlation = -1.0 to +1.0

+1.0  = Идеальная положительная корреляция (движутся вместе)
 0.0  = Нет корреляции (независимые движения)
-1.0  = Идеальная отрицательная корреляция (движутся противоположно)
```

**Реальные примеры:**

| Пара 1 | Пара 2 | Correlation | Интерпретация |
|--------|---------|-------------|---------------|
| BTCUSDT | ETHUSDT | 0.85 | Очень высокая - почти всегда движутся вместе |
| BTCUSDT | SOLUSDT | 0.78 | Высокая - часто движутся вместе |
| BTCUSDT | DOGEUSDT | 0.72 | Высокая - обычно движутся вместе |
| BTCUSDT | XRPUSDT | 0.68 | Средняя - иногда движутся по-разному |
| BTCUSDT | LINKUSDT | 0.75 | Высокая |
| ETHUSDT | SOLUSDT | 0.80 | Очень высокая |

**Формула (упрощенно):**
```python
correlation = np.corrcoef(returns_btc, returns_eth)[0, 1]
```

Для 170 пар это означает расчет:
```
Количество пар = 170 * 169 / 2 = 14,365 корреляций
```

---

### Шаг 4: Группировка по корреляции (жадный алгоритм)

**Порог группировки (из .env):**
```env
CORRELATION_MAX_THRESHOLD=0.7  # Пары с корреляцией ≥ 0.7 попадают в одну группу
```

**Алгоритм группировки:**

1. **Берем первую пару** (например, BTCUSDT)
2. **Ищем все пары**, коррелирующие с BTCUSDT ≥ 0.7:
   - ETHUSDT: 0.85 ✅
   - SOLUSDT: 0.78 ✅
   - DOGEUSDT: 0.72 ✅
   - LINKUSDT: 0.75 ✅
3. **Создаем группу:**
   ```
   Group_0: [BTCUSDT, ETHUSDT, SOLUSDT, DOGEUSDT, LINKUSDT]
   Avg correlation: 0.77
   ```
4. **Помечаем эти пары как обработанные**
5. **Переходим к следующей необработанной паре** и повторяем

**Важная особенность - транзитивность:**

```
Если:
  - BTCUSDT ↔ ETHUSDT = 0.85 (высокая)
  - ETHUSDT ↔ BNBUSDT = 0.75 (высокая)
  - BTCUSDT ↔ BNBUSDT = 0.55 (средняя, ниже порога)

То:
  - BTC, ETH, BNB все равно попадут в ОДНУ группу!
```

**Почему?**
Потому что когда обрабатывается BTC, находится ETH. Когда обрабатывается ETH, находится BNB. BNB добавляется в группу, даже если напрямую с BTC коррелирует слабо.

---

## Примеры группировки

### Пример 1: Типичные криптовалютные группы

**Группа "Major Coins":**
```
Group_0: [BTCUSDT, ETHUSDT, BNBUSDT, SOLUSDT, ADAUSDT]
Avg correlation: 0.78
Причина: Все крупные монеты движутся вместе за рынком
```

**Группа "Layer-1 Altcoins":**
```
Group_1: [AVAXUSDT, ATOMUSDT, DOTUSDT, NEARUSDT]
Avg correlation: 0.72
Причина: Схожие проекты, общая рыночная ниша
```

**Группа "DeFi tokens":**
```
Group_2: [UNIUSDT, AAVEUSDT, LINKUSDT, CRVUSDT]
Avg correlation: 0.75
Причина: DeFi сектор движется вместе
```

**Группа "Meme coins":**
```
Group_3: [DOGEUSDT, SHIBUSDT, 1000PEPEUSDT, FARTCOINUSDT]
Avg correlation: 0.80
Причина: Мемные монеты реагируют на одни триггеры
```

### Пример 2: Реальный сценарий на 170 парах

Допустим у вас:
- 170 торговых пар
- Threshold = 0.7
- Результат группировки:

```
✓ Создано 25 групп
✓ Покрыто 130/170 символов

Group_0: [BTCUSDT, ETHUSDT, BNBUSDT, ...] (8 пар) - avg_corr=0.79
Group_1: [AVAXUSDT, ATOMUSDT, ...] (6 пар) - avg_corr=0.74
Group_2: [DOGEUSDT, SHIBUSDT, ...] (5 пар) - avg_corr=0.81
...
Group_24: [LINKUSDT, BANDUSDT] (2 пары) - avg_corr=0.71

Не в группах (независимые): 40 пар
```

**40 пар не попали ни в какие группы** - это хорошо!
Значит они движутся независимо и не создают концентрации риска.

---

## Как ограничиваются позиции

**Параметр из .env:**
```env
CORRELATION_MAX_POSITIONS_PER_GROUP=1  # Максимум позиций в одной группе
```

### Сценарий 1: Лимит = 1 позиция (консервативно)

```
Group_0: [BTCUSDT, ETHUSDT, SOLUSDT, BNBUSDT]
```

**Действия:**
1. Открыли Long BTCUSDT ✅ (позиций в группе: 1/1)
2. Пытаемся открыть Long ETHUSDT ❌
   ```
   Отклонено: Достигнут лимит позиций в группе Group_0 (1/1)
   Коррелирующие активы: BTCUSDT, ETHUSDT, SOLUSDT, BNBUSDT
   ```
3. Пытаемся открыть Long SOLUSDT ❌ (та же группа!)
4. Можем открыть Long XRPUSDT ✅ (другая группа или нет группы)

**Результат:**
- ✅ Диверсификация - позиции по некоррелирующим активам
- ✅ Защита от обвала сектора

### Сценарий 2: Лимит = 2 позиции (сбалансированно)

```env
CORRELATION_MAX_POSITIONS_PER_GROUP=2
```

```
Group_0: [BTCUSDT, ETHUSDT, SOLUSDT, BNBUSDT]
```

**Действия:**
1. Открыли Long BTCUSDT ✅ (позиций: 1/2)
2. Открыли Long ETHUSDT ✅ (позиций: 2/2)
3. Пытаемся открыть Long SOLUSDT ❌ (лимит достигнут)

**Баланс:**
- Можно использовать силу корреляции (BTC + ETH усиливают друг друга)
- Но не перегружать портфель одной группой

---

## Проверка в коде

### Когда открывается позиция:

```python
# RiskManager вызывает
can_open, reason = correlation_manager.can_open_position(
    symbol="ETHUSDT",
    position_size_usdt=100.0
)

if not can_open:
    logger.warning(f"Позиция отклонена: {reason}")
    return False

# Если можно - открываем и уведомляем
correlation_manager.notify_position_opened("ETHUSDT", 100.0)
```

### Внутри `can_open_position()`:

```python
# Получаем группу
group = self.group_manager.get_group_for_symbol("ETHUSDT")

if not group:
    return True, None  # Нет группы = нет ограничений

# Проверяем лимит
if group.active_positions >= self.max_positions_per_group:
    reason = f"Достигнут лимит позиций в группе {group.group_id}"
    return False, reason

return True, None
```

---

## Настройка под ваши нужды

### Консервативная стратегия (минимум риска)

```env
CORRELATION_CHECK_ENABLED=true
CORRELATION_MAX_THRESHOLD=0.6           # Группировать даже слабо коррелирующие
CORRELATION_MAX_POSITIONS_PER_GROUP=1   # Только 1 позиция на группу
CORRELATION_LOOKBACK_DAYS=60            # Больше данных = стабильнее корреляция
```

**Результат:**
- Много групп (даже слабая корреляция учитывается)
- Максимальная диверсификация
- Меньше торговых возможностей

### Сбалансированная стратегия (рекомендуется)

```env
CORRELATION_CHECK_ENABLED=true
CORRELATION_MAX_THRESHOLD=0.7           # Только явно коррелирующие
CORRELATION_MAX_POSITIONS_PER_GROUP=2   # До 2 позиций на группу
CORRELATION_LOOKBACK_DAYS=30            # Баланс актуальности/стабильности
```

**Результат:**
- Умеренная диверсификация
- Достаточно торговых возможностей
- Хорошая защита от риска

### Агрессивная стратегия (больше сделок)

```env
CORRELATION_CHECK_ENABLED=true
CORRELATION_MAX_THRESHOLD=0.8           # Только очень высокая корреляция
CORRELATION_MAX_POSITIONS_PER_GROUP=3   # До 3 позиций на группу
CORRELATION_LOOKBACK_DAYS=14            # Быстрее адаптация к рынку
```

**Результат:**
- Меньше групп (только очень сильная корреляция)
- Больше торговых возможностей
- Выше риск при обвале сектора

### Отключить (не рекомендуется!)

```env
CORRELATION_CHECK_ENABLED=false
```

**Риск:**
Можете открыть 10 Long позиций по BTC, ETH, SOL, BNB, ADA и т.д.
Все они упадут одновременно при коррекции рынка.

---

## Мониторинг корреляционных групп

### В логах при инициализации:

```
[INFO] Инициализация корреляций для 170 символов...
[INFO] Загрузка исторических данных (30 дней)...
[INFO] ✓ Загружено данных для 168/170 символов
[INFO] Расчет correlation matrix...
[INFO] ✓ Рассчитано 14365 пар корреляций
[DEBUG] Высокая корреляция: BTCUSDT <-> ETHUSDT = 0.853
[DEBUG] Высокая корреляция: ETHUSDT <-> SOLUSDT = 0.782
[INFO] Группировка 170 символов по корреляции...
[INFO] Создана группа group_0: [BTCUSDT, ETHUSDT, SOLUSDT, ...] | avg_corr=0.791
[INFO] Создана группа group_1: [AVAXUSDT, ATOMUSDT, ...] | avg_corr=0.742
...
[INFO] Группировка завершена: создано 25 групп, покрыто 130/170 символов
[INFO] ✓ Инициализация завершена: групп=25, покрыто символов=130
```

### При попытке открыть позицию:

```
[INFO] ETHUSDT | ✓ Проверка корреляции пройдена: группа=group_0, позиций=0/1
[INFO] Позиция открыта в группе group_0: ETHUSDT | positions=1, exposure=100.00 USDT
```

### При отклонении:

```
[WARNING] SOLUSDT | Позиция отклонена: Достигнут лимит позиций в группе group_0 (1/1).
          Коррелирующие активы: BTCUSDT, ETHUSDT, SOLUSDT, BNBUSDT, ADAUSDT
```

---

## API endpoints (если есть)

Если в вашем боте есть REST API:

```bash
# Получить статистику корреляций
GET /api/v1/risk/correlation/stats

Response:
{
  "enabled": true,
  "total_groups": 25,
  "groups_with_positions": 3,
  "total_active_positions": 5,
  "total_exposure_usdt": 500.0,
  "last_update": "2025-10-30T10:00:00",
  "max_positions_per_group": 1,
  "correlation_threshold": 0.7
}

# Получить детали групп
GET /api/v1/risk/correlation/groups

Response:
[
  {
    "group_id": "group_0",
    "symbols": ["BTCUSDT", "ETHUSDT", "SOLUSDT"],
    "avg_correlation": 0.791,
    "active_positions": 1,
    "total_exposure_usdt": 100.0
  },
  ...
]
```

---

## Обновление корреляций

Корреляции **не статичны** - они меняются со временем!

**Рекомендуется обновлять:**
- Раз в сутки (автоматически)
- После крупных событий (вручную)

```python
# В коде обычно есть task
@periodic_task(hours=24)
async def update_correlations():
    await correlation_manager.update_correlations(symbols)
```

**Что происходит:**
1. Загружаются свежие 30 дней данных
2. Пересчитываются корреляции
3. Перегруппировываются пары
4. Если структура групп изменилась → предупреждение в логах

---

## Ответы на частые вопросы

### 1. Почему BTC и ETH в одной группе, хотя они разные монеты?

**Ответ:** Потому что их **цены движутся вместе**.
- Если BTC растет на 5%, ETH обычно тоже растет на 4-6%
- Корреляция = 0.85 (очень высокая)
- Открывая обе позиции, вы удваиваете риск, а не диверсифицируете

### 2. Как понять, какие пары в какой группе?

**Ответ:** Смотрите логи при запуске:
```
[INFO] Создана группа group_0: [BTCUSDT, ETHUSDT, ...] | avg_corr=0.791
```

Или используйте API/database для запроса текущих групп.

### 3. Может ли пара быть в нескольких группах?

**Ответ:** Нет, каждая пара может быть только в одной группе или ни в одной.

### 4. Что если корреляция изменилась, но у меня уже открыты позиции?

**Ответ:**
- Открытые позиции **не закрываются** автоматически
- При обновлении корреляций появится предупреждение
- Рекомендуется вручную пересмотреть портфель

### 5. Как работает CORRELATION_MAX_POSITIONS_PER_GROUP=1?

**Ответ:**
```
Group_0: [BTC, ETH, SOL, BNB] - 4 пары

Максимум 1 позиция = Можете открыть ЛЮБУЮ из этих 4 пар,
но только ОДНУ за раз.

Открыли BTC → ETH, SOL, BNB заблокированы
Закрыли BTC → Теперь можно открыть любую из 4
```

### 6. Почему 40 пар не попали ни в какие группы?

**Ответ:** Это **хорошо**!
Эти пары движутся независимо от других:
- Нишевые токены
- Новые листинги
- Стабильные монеты с низкой волатильностью

Для них нет корреляционных ограничений.

---

## Резюме

```
┌─────────────────────────────────────────────────────┐
│  КАК ПАРЫ ПОПАДАЮТ В ОДНУ ГРУППУ:                   │
├─────────────────────────────────────────────────────┤
│  1. Загружается 30 дней цен                         │
│  2. Вычисляются returns (% изменения)               │
│  3. Рассчитывается корреляция между всеми парами    │
│  4. Пары с correlation ≥ 0.7 группируются вместе    │
│  5. В группе можно открыть только N позиций         │
└─────────────────────────────────────────────────────┘

ЦЕЛЬ: Не открывать слишком много позиций по
      коррелирующим активам → диверсификация риска
```

**Настройки:**
- `CORRELATION_MAX_THRESHOLD=0.7` - порог группировки
- `CORRELATION_MAX_POSITIONS_PER_GROUP=1` - лимит позиций
- `CORRELATION_LOOKBACK_DAYS=30` - период расчета
