
<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bybit Screener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .table-container { height: calc(100vh - 140px); overflow-y: auto; }
        thead th {
            position: sticky;
            top: 0;
            background-color: #1f2937;
            font-size: 0.7rem;
            vertical-align: middle;
            text-align: center;
        }
        thead tr:last-child th {
            top: 28px; /* Высота первой строки, ~28px */
        }
        tbody td { font-size: 0.75rem; }
        .flash-green { animation: flash-green 1s ease-out; }
        .flash-red { animation: flash-red 1s ease-out; }
        @keyframes flash-green { 0% { background-color: rgba(16, 185, 129, 0.5); } 100% { background-color: transparent; } }
        @keyframes flash-red { 0% { background-color: rgba(239, 68, 68, 0.5); } 100% { background-color: transparent; } }
        .table-container::-webkit-scrollbar { width: 8px; }
        .table-container::-webkit-scrollbar-track { background: #1f2937; }
        .table-container::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; }
        .sort-asc::after { content: ' ▲'; }
        .sort-desc::after { content: ' ▼'; }
        .favorite-star { cursor: pointer; color: #4b5563; transition: color 0.2s; }
        .favorite-star.is-favorite { color: #f59e0b; }

        .alert-triggered-positive { background-color: #10b981 !important; animation: pulse-green 2s infinite; }
        .alert-triggered-negative { background-color: #ef4444 !important; animation: pulse-red 2s infinite; }
        @keyframes pulse-green { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .alert-input {
            width: 90%;
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
            text-align: center;
            border-radius: 4px;
            padding: 2px;
            font-size: 0.75rem;
            -moz-appearance: textfield;
        }
        .alert-input::-webkit-outer-spin-button,
        .alert-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .alert-input::placeholder {
            color: #6b7280;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4">
        <header class="mb-4">
            <h1 class="text-3xl font-bold text-white">Bybit Futures Screener</h1>
            <div class="flex justify-between items-center mt-2">
                <div class="flex items-center space-x-4">
                    <div id="status-indicator" class="w-4 h-4 rounded-full bg-yellow-500 animate-pulse"></div>
                    <span id="status-text" class="text-gray-400">Подключение...</span>
                </div>
                <input type="text" id="filter-input" placeholder="Фильтр по тикеру..." class="bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </header>

        <div class="table-container rounded-lg border border-gray-700">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-800">
                    <tr>
                        <th class="px-2 py-2" rowspan="2">★</th>
                        <th class="px-4 py-2 text-left uppercase tracking-wider cursor-pointer" data-sort="symbol" rowspan="2">Тикер</th>
                        <th class="px-4 py-2 text-right uppercase tracking-wider cursor-pointer" data-sort="last_price" rowspan="2">Цена</th>
                        <th class="px-4 py-2 text-right uppercase tracking-wider cursor-pointer" data-sort="metrics.volume_change_pct" rowspan="2">Объем%</th>
                        <th class="px-4 py-2 text-right uppercase tracking-wider cursor-pointer" data-sort="metrics.change_1m">1m%</th>
                        <th class="px-4 py-2 text-right uppercase tracking-wider cursor-pointer" data-sort="metrics.change_2m">2m%</th>
                        <th class="px-4 py-2 text-right uppercase tracking-wider cursor-pointer" data-sort="metrics.change_3m">3m%</th>
                        <th class="px-4 py-2 text-right uppercase tracking-wider cursor-pointer" data-sort="metrics.change_5m">5m%</th>
                        <th class="px-4 py-2 text-right uppercase tracking-wider cursor-pointer" data-sort="metrics.change_15m">15m%</th>
                        <th class="px-4 py-2 text-right uppercase tracking-wider cursor-pointer" data-sort="metrics.change_1h" rowspan="2">1h%</th>
                        <th class="px-4 py-2 text-right uppercase tracking-wider cursor-pointer" data-sort="metrics.change_4h" rowspan="2">4h%</th>
                        <th class="px-4 py-2 text-right uppercase tracking-wider cursor-pointer" data-sort="metrics.change_24h" rowspan="2">24h% (1h)</th>
                        <th class="px-4 py-2 text-right uppercase tracking-wider cursor-pointer" data-sort="metrics.rsi_14" rowspan="2">RSI</th>
                        <th class="px-4 py-2 text-right uppercase tracking-wider cursor-pointer" data-sort="metrics.atr_14" rowspan="2">ATR</th>
                        <th class="px-4 py-2 text-center uppercase tracking-wider cursor-pointer" data-sort="metrics.is_above_ema200" rowspan="2">EMA</th>
                        <th class="px-4 py-2 text-center uppercase tracking-wider cursor-pointer" data-sort="metrics.rsi_trend" rowspan="2">RSI Trend</th>
                        <th class="px-4 py-2 text-center uppercase tracking-wider cursor-pointer" data-sort="metrics.psar_trend" rowspan="2">PSAR</th>
                        <th class="px-4 py-2 text-center uppercase tracking-wider cursor-pointer" data-sort="metrics.aroon_trend" rowspan="2">Aroon</th>
                        <th class="px-4 py-2 text-center uppercase tracking-wider cursor-pointer" data-sort="metrics.reversal_signal" rowspan="2">Разворот</th>
                    </tr>
                    <tr>
                        <th class="p-1"><input type="number" class="alert-input" data-period="1m" step="0.1" placeholder="±%"></th>
                        <th class="p-1"><input type="number" class="alert-input" data-period="2m" step="0.1" placeholder="±%"></th>
                        <th class="p-1"><input type="number" class="alert-input" data-period="3m" step="0.1" placeholder="±%"></th>
                        <th class="p-1"><input type="number" class="alert-input" data-period="5m" step="0.1" placeholder="±%"></th>
                        <th class="p-1"><input type="number" class="alert-input" data-period="15m" step="0.1" placeholder="±%"></th>
                    </tr>
                </thead>
                <tbody id="screener-table-body" class="bg-gray-900 divide-y divide-gray-800">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const screenerTableBody = document.getElementById('screener-table-body');
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const filterInput = document.getElementById('filter-input');

            let allPairsData = [];
            let sortState = { key: 'metrics.change_5m', direction: 'desc' };
            let favorites = new Set(JSON.parse(localStorage.getItem('screenerFavorites')) || []);
            let chart = null;
            let currentChartSymbol = null;

            let alertTargets = JSON.parse(localStorage.getItem('alertTargets')) || {};
            let alertTriggered = new Set();
            let alertAudio = null;
            let alertTimeouts = new Map();
            let alertsInputsLoaded = false;

            const initAudio = () => {
                if (alertAudio) return;
                alertAudio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmgfCEmLzuzN');
                alertAudio.volume = 0.3;
            };

            const playAlert = (symbol, period) => {
                initAudio();
                const alertKey = `${symbol}_${period}`;
                if (alertTimeouts.has(alertKey)) return;

                const playBeep = () => {
                    alertAudio.play().catch(e => console.log('Audio playback blocked by browser.'));
                };
                playBeep();
                const interval = setInterval(playBeep, 3000);
                const timeout = setTimeout(() => {
                    clearInterval(interval);
                    alertTimeouts.delete(alertKey);
                }, 60000);
                alertTimeouts.set(alertKey, { interval, timeout });
            };

            const stopAlert = (symbol, period) => {
                const alertKey = `${symbol}_${period}`;
                const alertData = alertTimeouts.get(alertKey);
                if (alertData) {
                    clearInterval(alertData.interval);
                    clearTimeout(alertData.timeout);
                    alertTimeouts.delete(alertKey);
                }
            };

            const connectWebSocket = () => {
                const ws = new WebSocket(`ws://${window.location.host}/ws/screener`);
                ws.onopen = () => {
                    statusIndicator.classList.remove('bg-yellow-500', 'bg-red-500', 'animate-pulse');
                    statusIndicator.classList.add('bg-green-500');
                    statusText.textContent = 'Connected. Waiting for data...';
                };
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.pairs && data.pairs.length > 0) {
                        statusText.textContent = `Connected. Pairs: ${data.pairs.length}. Last update: ${new Date().toLocaleTimeString()}`;
                        allPairsData = data.pairs;

                        if (!alertsInputsLoaded && allPairsData.length > 0) {
                            loadAlertInputs();
                            alertsInputsLoaded = true;
                        }

                        renderTable();
                    }
                };
                ws.onclose = () => {
                    statusIndicator.classList.remove('bg-green-500');
                    statusIndicator.classList.add('bg-red-500', 'animate-pulse');
                    statusText.textContent = 'Disconnected. Reconnecting in 5s...';
                    setTimeout(connectWebSocket, 5000);
                };
                ws.onerror = () => ws.close();
            };

            const getNestedValue = (obj, path) => path.split('.').reduce((acc, part) => acc && acc[part], obj);

            const toggleFavorite = (symbol) => {
                if (favorites.has(symbol)) favorites.delete(symbol);
                else favorites.add(symbol);
                localStorage.setItem('screenerFavorites', JSON.stringify(Array.from(favorites)));
                renderTable();
            };

            const checkAlert = (symbol, period, value) => {
                const key = `${symbol}_${period}`;
                const target = alertTargets[key];

                if (!target || value === null) {
                    alertTriggered.delete(key);
                    return '';
                }

                const triggered = (target > 0 && value >= target) || (target < 0 && value <= target);

                if (triggered) {
                    if (!alertTriggered.has(key)) {
                        alertTriggered.add(key);
                        playAlert(symbol, period);
                    }
                    return target > 0 ? 'alert-triggered-positive' : 'alert-triggered-negative';
                } else {
                    alertTriggered.delete(key);
                    return '';
                }
            };

            const renderTable = () => {
                if (allPairsData.length === 0) return;

                let chartRowToPreserve = null;
                const existingChartRow = document.getElementById('chart-row');
                if (existingChartRow) {
                    chartRowToPreserve = existingChartRow;
                    existingChartRow.remove();
                }

                const filterValue = filterInput.value.toUpperCase();
                const filteredData = filterValue ? allPairsData.filter(p => p.symbol.includes(filterValue)) : allPairsData;

                const sortedData = [...filteredData].sort((a, b) => {
                    const aIsFav = favorites.has(a.symbol);
                    const bIsFav = favorites.has(b.symbol);
                    if (aIsFav !== bIsFav) return aIsFav ? -1 : 1;

                    const valA = getNestedValue(a, sortState.key) ?? -Infinity;
                    const valB = getNestedValue(b, sortState.key) ?? -Infinity;
                    if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                    return 0;
                });

                const formatReversalSignal = (val) => {
                    if (val === 1) {
                        return '<span class="font-bold text-green-400">▲ BUY</span>';
                    }
                    return '—';
                };

                const tableBody = document.createDocumentFragment();
                sortedData.forEach(pair => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-800 transition-colors duration-150 cursor-pointer';
                    row.setAttribute('data-symbol', pair.symbol);

                    const oldRow = screenerTableBody.querySelector(`tr[data-symbol="${pair.symbol}"]`);
                    const oldPrice = oldRow ? parseFloat(oldRow.children[2].dataset.price) : 0;
                    const newPrice = pair.last_price;

                    let priceClass = '';
                    if (oldPrice !== 0 && newPrice > oldPrice) priceClass = 'flash-green';
                    else if (oldPrice !== 0 && newPrice < oldPrice) priceClass = 'flash-red';

                    const formatPercent = (val) => val != null ? `${val.toFixed(2)}%` : '—';
                    const formatNum = (val) => val != null ? val.toFixed(2) : '—';
                    const formatATR = (val) => val != null ? val.toFixed(6) : '—';
                    const formatTrend = (val) => val === true ? '<span class="text-green-400">▲</span>' : val === false ? '<span class="text-red-400">▼</span>' : '<span class="text-gray-500">-</span>';
                    const formatSignal = (val) => val === 1 ? '<span class="font-bold text-green-400">Up</span>' : val === -1 ? '<span class="font-bold text-red-500">Down</span>' : '—';
                    const formatRsiTrend = (val) => val === 1 ? '<span class="font-bold text-green-400">Buy</span>' : val === -1 ? '<span class="font-bold text-red-500">Sell</span>' : '—';
                    const getTextColor = (val) => val > 0 ? 'text-green-400' : val < 0 ? 'text-red-400' : 'text-gray-400';

                    const change24h = pair.metrics.change_24h;
                    const change1h_for_24 = pair.metrics.change_1h_for_24h_display;
                    const display24h = `${formatPercent(change24h)} ${change1h_for_24 != null ? `<span class="text-xs ${getTextColor(change1h_for_24)}">(${change1h_for_24.toFixed(2)}%)</span>` : ''}`;

                    row.innerHTML = `
                        <td class="px-2 py-2 text-center text-lg"><span class="favorite-star ${favorites.has(pair.symbol) ? 'is-favorite' : ''}">★</span></td>
                        <td class="px-4 py-2 text-left whitespace-nowrap font-bold text-white">${pair.symbol}</td>
                        <td class="px-4 py-2 text-right whitespace-nowrap font-semibold ${priceClass}" data-price="${newPrice}">${newPrice > 0 ? newPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 4 }) : '—'}</td>
                        <td class="px-4 py-2 text-right whitespace-nowrap ${getTextColor(pair.metrics.volume_change_pct)}">${formatPercent(pair.metrics.volume_change_pct)}</td>
                        <td class="px-4 py-2 text-right whitespace-nowrap ${getTextColor(pair.metrics.change_1m)} ${checkAlert(pair.symbol, '1m', pair.metrics.change_1m)}">${formatPercent(pair.metrics.change_1m)}</td>
                        <td class="px-4 py-2 text-right whitespace-nowrap ${getTextColor(pair.metrics.change_2m)} ${checkAlert(pair.symbol, '2m', pair.metrics.change_2m)}">${formatPercent(pair.metrics.change_2m)}</td>
                        <td class="px-4 py-2 text-right whitespace-nowrap ${getTextColor(pair.metrics.change_3m)} ${checkAlert(pair.symbol, '3m', pair.metrics.change_3m)}">${formatPercent(pair.metrics.change_3m)}</td>
                        <td class="px-4 py-2 text-right whitespace-nowrap ${getTextColor(pair.metrics.change_5m)} ${checkAlert(pair.symbol, '5m', pair.metrics.change_5m)}">${formatPercent(pair.metrics.change_5m)}</td>
                        <td class="px-4 py-2 text-right whitespace-nowrap ${getTextColor(pair.metrics.change_15m)} ${checkAlert(pair.symbol, '15m', pair.metrics.change_15m)}">${formatPercent(pair.metrics.change_15m)}</td>
                        <td class="px-4 py-2 text-right whitespace-nowrap ${getTextColor(pair.metrics.change_1h)}">${formatPercent(pair.metrics.change_1h)}</td>
                        <td class="px-4 py-2 text-right whitespace-nowrap ${getTextColor(pair.metrics.change_4h)}">${formatPercent(pair.metrics.change_4h)}</td>
                        <td class="px-4 py-2 text-right whitespace-nowrap ${getTextColor(change24h)}">${display24h}</td>
                        <td class="px-4 py-2 text-right whitespace-nowrap">${formatNum(pair.metrics.rsi_14)}</td>
                        <td class="px-4 py-2 text-right whitespace-nowrap">${formatATR(pair.metrics.atr_14)}</td>
                        <td class="px-4 py-2 text-center whitespace-nowrap font-semibold">${formatTrend(pair.metrics.is_above_ema200)}</td>
                        <td class="px-4 py-2 text-center whitespace-nowrap">${formatRsiTrend(pair.metrics.rsi_trend)}</td>
                        <td class="px-4 py-2 text-center whitespace-nowrap font-semibold">${formatSignal(pair.metrics.psar_trend)}</td>
                        <td class="px-4 py-2 text-center whitespace-nowrap font-semibold">${formatSignal(pair.metrics.aroon_trend)}</td>
                        <td class="px-4 py-2 text-center whitespace-nowrap">${formatReversalSignal(pair.metrics.reversal_signal)}</td>
                    `;
                    tableBody.appendChild(row);
                });

                screenerTableBody.innerHTML = '';
                screenerTableBody.appendChild(tableBody);

                if (chartRowToPreserve && currentChartSymbol) {
                    const parentRow = screenerTableBody.querySelector(`tr[data-symbol="${currentChartSymbol}"]`);
                    if (parentRow) {
                        parentRow.parentNode.insertBefore(chartRowToPreserve, parentRow.nextSibling);
                    } else {
                        currentChartSymbol = null;
                        chart = null;
                    }
                }
            };

            const toggleChart = (rowElement) => {
                const symbol = rowElement.getAttribute('data-symbol');
                if (!symbol) return;

                const existingChartRow = document.getElementById('chart-row');

                ['1m', '2m', '3m', '5m', '15m'].forEach(period => stopAlert(symbol, period));

                if (currentChartSymbol === symbol && existingChartRow) {
                    if (chart) chart.remove();
                    chart = null;
                    existingChartRow.remove();
                    currentChartSymbol = null;
                    return;
                }

                if (existingChartRow) {
                    if (chart) chart.remove();
                    chart = null;
                    existingChartRow.remove();
                }

                currentChartSymbol = symbol;
                const chartRow = document.createElement('tr');
                chartRow.id = 'chart-row';
                const chartCell = document.createElement('td');
                chartCell.colSpan = 19; // Увеличиваем на 1 из-за нового столбца
                const chartContainer = document.createElement('div');
                chartContainer.id = 'chart-container';
                chartContainer.style.height = '400px';
                chartContainer.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">Loading chart for ${symbol}...</div>`;
                chartCell.appendChild(chartContainer);
                chartRow.appendChild(chartCell);
                rowElement.parentNode.insertBefore(chartRow, rowElement.nextSibling);

                renderChart(symbol, chartContainer);
            };

            const renderChart = async (symbol, container) => {
                container.innerHTML = '';

                try {
                    if (typeof LightweightCharts === 'undefined') {
                        container.innerHTML = `<div class="flex items-center justify-center h-full text-red-500">Error: Charting library not loaded.</div>`;
                        return;
                    }

                    chart = LightweightCharts.createChart(container, {
                        width: container.clientWidth,
                        height: container.clientHeight,
                        layout: { backgroundColor: '#111827', textColor: '#d1d5db' },
                        grid: { vertLines: { color: '#2a313e' }, horzLines: { color: '#2a313e' } },
                        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                        priceScale: { borderColor: '#485c7b' },
                        timeScale: { borderColor: '#485c7b', timeVisible: true, secondsVisible: false },
                    });

                    const candleSeries = chart.addCandlestickSeries({
                        upColor: '#16a34a', downColor: '#ef4444',
                        borderDownColor: '#ef4444', borderUpColor: '#16a34a',
                        wickDownColor: '#ef4444', wickUpColor: '#16a34a',
                    });

                    const response = await fetch(`/api/klines/${symbol}`);
                    if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                    const klines = await response.json();

                    if (klines && klines.length > 0) {
                        candleSeries.setData(klines);
                        chart.timeScale().fitContent();
                    } else {
                        container.innerHTML = `<div class="flex items-center justify-center h-full text-yellow-500">No chart data available for ${symbol}.</div>`;
                    }
                } catch (error) {
                    console.error("Chart rendering error:", error);
                    if(container) container.innerHTML = `<div class="flex items-center justify-center h-full text-red-500">Error: ${error.message}</div>`;
                }
            };

            const loadAlertInputs = () => {
                const firstSymbol = allPairsData[0].symbol;
                document.querySelectorAll('.alert-input').forEach(input => {
                    const period = input.dataset.period;
                    const alertKey = `${firstSymbol}_${period}`;
                    const savedValue = alertTargets[alertKey];
                    if (savedValue) {
                        input.value = savedValue;
                    }
                });
            };

            document.addEventListener('input', (e) => {
                if (e.target.classList.contains('alert-input')) {
                    const period = e.target.dataset.period;
                    const value = parseFloat(e.target.value);

                    const updateAlerts = (keyAction) => {
                        allPairsData.forEach(pair => keyAction(pair, period));
                        localStorage.setItem('alertTargets', JSON.stringify(alertTargets));
                    };

                    if (!isNaN(value) && value !== 0) {
                        updateAlerts((pair, p) => alertTargets[`${pair.symbol}_${p}`] = value);
                    } else {
                        updateAlerts((pair, p) => delete alertTargets[`${pair.symbol}_${p}`]);
                    }
                }
            });

            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', (e) => {
                    if (e.target.classList.contains('alert-input')) return;

                    const newSortKey = th.dataset.sort;
                    if (sortState.key === newSortKey) {
                        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.key = newSortKey;
                        sortState.direction = 'desc';
                    }

                    document.querySelectorAll('th[data-sort]').forEach(h => {
                        h.classList.remove('sort-asc', 'sort-desc');
                        if (h === th) {
                            h.classList.add(sortState.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                        }
                    });
                    renderTable();
                });
            });

            screenerTableBody.addEventListener('click', (e) => {
                const star = e.target.closest('.favorite-star');
                if (star) {
                    e.stopPropagation();
                    const row = star.closest('tr[data-symbol]');
                    if (row) toggleFavorite(row.dataset.symbol);
                    return;
                }
                const row = e.target.closest('tr[data-symbol]');
                if (row) toggleChart(row);
            });

            filterInput.addEventListener('input', renderTable);

            connectWebSocket();
            document.addEventListener('click', initAudio, { once: true });
        });
    </script>
</body>
</html>