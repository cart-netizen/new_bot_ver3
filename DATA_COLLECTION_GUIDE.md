# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Å–±–æ—Ä—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è ML –º–æ–¥–µ–ª–µ–π

## üìä –û–±–∑–æ—Ä

–° –≤–µ—Ä—Å–∏–∏ 3.x –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ **–¥–≤—É—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö**:

1. **Feature Store (parquet)** - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø
2. **Legacy (.npy/.json)** - —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

```
–ë–û–¢ –†–ê–ë–û–¢–ê–ï–¢
  ‚Üì
–ö–∞–∂–¥—ã–µ 10 –∏—Ç–µ—Ä–∞—Ü–∏–π (~30 —Å–µ–∫—É–Ω–¥)
  ‚Üì
MLDataCollector.collect_sample()
  ‚îú‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –±—É—Ñ–µ—Ä (RAM)
  ‚îÇ
  ‚îî‚îÄ –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 2000 —Å–µ–º–ø–ª–æ–≤ (~16 —á–∞—Å–æ–≤):
      ‚îú‚îÄ –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ Feature Store ‚Üí data/feature_store/offline/*.parquet
      ‚îî‚îÄ –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ legacy —Ñ–æ—Ä–º–∞—Ç ‚Üí data/ml_training/SYMBOL/*.npy
```

### –ß–∞—Å—Ç–æ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| –°–±–æ—Ä —Å–µ–º–ø–ª–æ–≤ | –ö–∞–∂–¥—ã–µ **30 —Å–µ–∫—É–Ω–¥** (10 –∏—Ç–µ—Ä–∞—Ü–∏–π √ó 3 —Å–µ–∫) |
| –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª—ã | –ö–∞–∂–¥—ã–µ **2000 —Å–µ–º–ø–ª–æ–≤** (~16 —á–∞—Å–æ–≤) |
| –°–æ–∑–¥–∞–µ—Ç—Å—è —Ñ–∞–π–ª–æ–≤ | **1-2 —Ñ–∞–π–ª–∞ –≤ –¥–µ–Ω—å** –Ω–∞ —Å–∏–º–≤–æ–ª |

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Feature Store (parquet)
ls -lh data/feature_store/offline/training_features/

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å legacy —Ñ–æ—Ä–º–∞—Ç
ls -lh data/ml_training/BTCUSDT/features/

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–æ–≤ –≤ –ª–æ–≥–∞—Ö –±–æ—Ç–∞
# –ò—â–∏—Ç–µ: "MLDataCollector —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: collected=XXX"
```

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è legacy –¥–∞–Ω–Ω—ã—Ö –≤ parquet

–ï—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ legacy —Ñ–æ—Ä–º–∞—Ç–µ (.npy/.json), –º–∏–≥—Ä–∏—Ä—É–π—Ç–µ –∏—Ö –≤ parquet:

```bash
# –ú–∏–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤
python migrate_legacy_to_parquet.py
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:**
1. –ß–∏—Ç–∞–µ—Ç data/ml_training/SYMBOL/ (.npy –∏ .json —Ñ–∞–π–ª—ã)
2. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ DataFrame
3. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ data/feature_store/offline/training_features/ (parquet)

**–í—ã–≤–æ–¥:**
```
–ú–ò–ì–†–ê–¶–ò–Ø: Legacy ‚Üí Feature Store (Parquet)
================================================================================
–ù–∞–π–¥–µ–Ω–æ —Å–∏–º–≤–æ–ª–æ–≤: 3
–°–∏–º–≤–æ–ª—ã: BTCUSDT, ETHUSDT, 4USDT

======================================================================
–ú–∏–≥—Ä–∞—Ü–∏—è BTCUSDT
======================================================================
  –ù–∞–π–¥–µ–Ω–æ –±–∞—Ç—á–µ–π: 5
  ‚úì 2025-11-07_batch_0001.npy: 2000 —Å–µ–º–ø–ª–æ–≤
  ‚úì 2025-11-07_batch_0002.npy: 2000 —Å–µ–º–ø–ª–æ–≤
  ...

–ò–¢–û–ì–ò –ú–ò–ì–†–ê–¶–ò–ò
================================================================================
‚úì –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –±–∞—Ç—á–µ–π: 15
‚úì –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å–µ–º–ø–ª–æ–≤: 30,000
================================================================================
```

---

## üè∑Ô∏è –î–æ–±–∞–≤–ª–µ–Ω–∏–µ future labels (preprocessing)

**–í–∞–∂–Ω–æ:** –ü–æ—Å–ª–µ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∫–∏ –æ –±—É–¥—É—â–µ–º –¥–≤–∏–∂–µ–Ω–∏–∏ —Ü–µ–Ω—ã!

### –î–ª—è parquet –¥–∞–Ω–Ω—ã—Ö (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

```bash
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
python preprocessing_add_future_labels_parquet.py

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥
python preprocessing_add_future_labels_parquet.py \
  --start-date 2025-11-01 \
  --end-date 2025-11-07

# –£–∫–∞–∑–∞—Ç—å feature group
python preprocessing_add_future_labels_parquet.py \
  --feature-group training_features
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ß–∏—Ç–∞–µ—Ç parquet –¥–∞–Ω–Ω—ã–µ –∏–∑ Feature Store
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–º–ø–ª–∞ –Ω–∞—Ö–æ–¥–∏—Ç —Ü–µ–Ω—É —á–µ—Ä–µ–∑ 10s, 30s, 60s
3. –í—ã—á–∏—Å–ª—è–µ—Ç:
   - `future_direction` (0=DOWN, 1=NEUTRAL, 2=UP)
   - `future_movement` (–ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã)
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ Feature Store

**–í—ã–≤–æ–¥:**
```
PREPROCESSING: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Future Labels (Parquet)
================================================================================
‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ 30,000 —Å–µ–º–ø–ª–æ–≤
  –°–∏–º–≤–æ–ª—ã: ['BTCUSDT', 'ETHUSDT', '4USDT']

======================================================================
–û–±—Ä–∞–±–æ—Ç–∫–∞ BTCUSDT
======================================================================
  –°–µ–º–ø–ª–æ–≤: 10,000
  ‚úì –ü–æ–º–µ—á–µ–Ω–æ: 9,800/10,000 —Å–µ–º–ø–ª–æ–≤ (98.0%)

–ò–¢–û–ì–ò PREPROCESSING
================================================================================
‚úì –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–µ–º–ø–ª–æ–≤: 30,000
‚úì –ü–æ–º–µ—á–µ–Ω–æ future labels: 29,400
  –ü—Ä–æ—Ü–µ–Ω—Ç –º–µ—Ç–æ–∫: 98.0%
================================================================================
```

### –î–ª—è legacy –¥–∞–Ω–Ω—ã—Ö (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç)

```bash
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤
python preprocessing_add_future_labels.py
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```
data/
‚îú‚îÄ‚îÄ feature_store/
‚îÇ   ‚îî‚îÄ‚îÄ offline/
‚îÇ       ‚îî‚îÄ‚îÄ training_features/        ‚Üê ‚úÖ Parquet —Ñ–æ—Ä–º–∞—Ç (–ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –¥–ª—è –æ–±—É—á–µ–Ω–∏—è)
‚îÇ           ‚îú‚îÄ‚îÄ date=2025-11-07/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ features_100012.parquet
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ features_140523.parquet
‚îÇ           ‚îî‚îÄ‚îÄ date=2025-11-08/
‚îÇ               ‚îî‚îÄ‚îÄ features_091245.parquet
‚îÇ
‚îî‚îÄ‚îÄ ml_training/                      ‚Üê ‚ö†Ô∏è Legacy —Ñ–æ—Ä–º–∞—Ç (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    ‚îú‚îÄ‚îÄ BTCUSDT/
    ‚îÇ   ‚îú‚îÄ‚îÄ features/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 2025-11-07_batch_0001.npy
    ‚îÇ   ‚îú‚îÄ‚îÄ labels/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 2025-11-07_batch_0001.json
    ‚îÇ   ‚îî‚îÄ‚îÄ metadata/
    ‚îÇ       ‚îî‚îÄ‚îÄ 2025-11-07_batch_0001.json
    ‚îî‚îÄ‚îÄ ...
```

---

## üéØ Workflow: –û—Ç —Å–±–æ—Ä–∞ –¥–æ –æ–±—É—á–µ–Ω–∏—è

### 1. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞
python -m backend.main

# –î–∞–π—Ç–µ –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å –º–∏–Ω–∏–º—É–º 24 —á–∞—Å–∞
# MLDataCollector –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ
```

### 2. –ú–∏–≥—Ä–∞—Ü–∏—è legacy –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –µ—Å—Ç—å)

```bash
# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
python migrate_legacy_to_parquet.py
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ future labels

```bash
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ! –ë–µ–∑ —ç—Ç–æ–≥–æ –º–æ–¥–µ–ª—å –Ω–µ –æ–±—É—á–∏—Ç—Å—è
python preprocessing_add_future_labels_parquet.py
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–º–ø–ª–æ–≤
python -c "
import pandas as pd
from pathlib import Path
from backend.ml_engine.feature_store.feature_store import get_feature_store

fs = get_feature_store()
df = fs.read_offline_features('training_features')
print(f'–í—Å–µ–≥–æ —Å–µ–º–ø–ª–æ–≤: {len(df):,}')
print(f'–°–∏–º–≤–æ–ª—ã: {df[\"symbol\"].unique()}')
print(f'–° –º–µ—Ç–∫–∞–º–∏: {df[\"future_direction_60s\"].notna().sum():,}')
"
```

### 5. –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏

```bash
# –ß–µ—Ä–µ–∑ CLI
python -m backend.ml_engine.training_orchestrator --epochs 50

# –ò–ª–∏ —á–µ—Ä–µ–∑ frontend
# ML Management ‚Üí Start Training
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MLDataCollector

–í `backend/main.py`:

```python
self.ml_data_collector = MLDataCollector(
    storage_path="../data/ml_training",
    max_samples_per_file=2000,
    collection_interval=10,
    max_buffer_memory_mb=200,

    # Feature Store
    enable_feature_store=True,  # ‚úÖ –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤ parquet
    use_legacy_format=True,     # ‚úÖ –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤ .npy/.json
    feature_store_group="training_features"
)
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- `enable_feature_store=True` - –í–°–ï–ì–î–ê –≤–∫–ª—é—á–∞–π—Ç–µ –¥–ª—è –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- `use_legacy_format=True` - –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- `max_samples_per_file=2000` - –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è parquet (2-5 MB –Ω–∞ —Ñ–∞–π–ª)

---

## üìä –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–∞–Ω–Ω—ã–º –¥–ª—è –æ–±—É—á–µ–Ω–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ú–∏–Ω–∏–º—É–º | –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |
|----------|---------|---------------|
| **–í—Å–µ–≥–æ —Å–µ–º–ø–ª–æ–≤** | 600+ | 10,000+ |
| **–ü—Ä–∏–∑–Ω–∞–∫–æ–≤ (features)** | 110 | 110 |
| **–°–∏–º–≤–æ–ª–æ–≤** | 1 | 3+ |
| **–ü–µ—Ä–∏–æ–¥ —Å–±–æ—Ä–∞** | 12 —á–∞—Å–æ–≤ | 7+ –¥–Ω–µ–π |
| **Future labels** | 80%+ | 95%+ |

---

## üîç Troubleshooting

### "No training data available"

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
ls data/feature_store/offline/training_features/

# –ï—Å–ª–∏ –ø—É—Å—Ç–æ - –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
python -m backend.main
```

### "Insufficient data: X samples, need at least Y"

–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö. –î–∞–π—Ç–µ –±–æ—Ç—É –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ–ª—å—à–µ –∏–ª–∏ —Å–Ω–∏–∑—å—Ç–µ `sequence_length` –≤ `DataConfig`.

### "Future labels = None"

–ó–∞–ø—É—Å—Ç–∏—Ç–µ preprocessing —Å–∫—Ä–∏–ø—Ç:
```bash
python preprocessing_add_future_labels_parquet.py
```

### "Schema validation failed"

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤ –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å –≤—Å–µ 110 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ + –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ. –°–º. `backend/ml_engine/feature_store/feature_schema.py`.

---

## ‚úÖ Checklist –ø–µ—Ä–µ–¥ –æ–±—É—á–µ–Ω–∏–µ–º

- [ ] –ë–æ—Ç —Å–æ–±—Ä–∞–ª –º–∏–Ω–∏–º—É–º 600+ —Å–µ–º–ø–ª–æ–≤
- [ ] –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Feature Store (parquet)
- [ ] –ó–∞–ø—É—â–µ–Ω preprocessing –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è future labels
- [ ] –ú–∏–Ω–∏–º—É–º 80% —Å–µ–º–ø–ª–æ–≤ –∏–º–µ—é—Ç –º–µ—Ç–∫–∏
- [ ] Schema –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ

---

## üìö –°–º. —Ç–∞–∫–∂–µ

- `MLFLOW_POSTGRES_FIX.md` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL –¥–ª—è MLflow
- `ML_INFRASTRUCTURE_GUIDE.md` - –ø–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ ML –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ
- `data/README.md` - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏ troubleshooting
